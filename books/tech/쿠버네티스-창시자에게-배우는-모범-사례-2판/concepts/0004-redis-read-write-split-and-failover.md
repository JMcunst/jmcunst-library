# 레디스 읽기/쓰기 분리와 Failover (Redis Read/Write Split and Failover)

## 정의

레디스 트래픽을 읽기와 쓰기로 나누어 각기 다른 서비스 엔드포인트로 라우팅하고, 마스터 장애 시 자동으로 쓰기 대상이 전환되도록 운영하는 방법.

## 왜 중요한가?

- 읽기 부하를 레플리카로 분산해 마스터 부담을 줄일 수 있다.
- 쓰기 경로를 명확히 분리해야 일관성 문제가 줄어든다.
- 장애 시 쓰기 엔드포인트가 빠르게 새 마스터로 전환되지 않으면 서비스 중단 시간이 길어진다.

## 책 내용 핵심 정리

- 읽기용 서비스는 일반 `ClusterIP Service`로 구성해 레플리카들로 트래픽을 분산할 수 있다.
- 쓰기는 마스터가 처리하므로 `Headless Service`와 스테이트풀셋 DNS(`redis-0.redis`)를 이용해 특정 파드(마스터)로 보낼 수 있다.
- 읽기/쓰기 요청을 다른 클라이언트 경로로 분리해 접근해야 한다.

## 읽기/쓰기 구별 방법

### 1. 클라이언트 엔드포인트를 분리한다
- 읽기 전용 클라이언트: `redis-read` 같은 읽기 서비스로 접속
- 쓰기 또는 읽기/쓰기 트랜잭션 클라이언트: `redis-write` 같은 쓰기 서비스로 접속

### 2. 서비스 선택자를 역할 기준으로 관리한다
- `role=replica`를 읽기 서비스 selector로 사용
- `role=master`를 쓰기 서비스 selector로 사용
- 앱 코드에서 명령 단위로 분기하지 말고, 커넥션 레벨에서 분리하는 것이 운영상 안전하다.

### 3. 트랜잭션/락/카운터는 항상 쓰기 경로로 보낸다
- `INCR`, `SET`, `MULTI/EXEC`, 분산락 같은 명령은 반드시 `redis-write`를 사용한다.
- 읽기 후 바로 쓰는 요청도 같은 쓰기 경로를 사용해야 레플리카 지연 이슈를 줄일 수 있다.

## Failover 방법

### 핵심 포인트

`redis-0` 같은 고정 파드 DNS를 직접 쓰기 엔드포인트로 고정하면, 해당 파드 장애 시 자동 전환이 어렵다.  
Failover를 하려면 "현재 마스터를 동적으로 가리키는 주소"가 필요하다.

### 방법 A: Sentinel 기반

1. Sentinel이 마스터 장애를 감지한다.
2. 레플리카 하나를 새 마스터로 승격한다.
3. 클라이언트가 Sentinel에 질의해 새 마스터 주소로 재접속한다.

### 방법 B: Operator + Service selector 기반

1. Operator가 마스터 장애를 감지하고 레플리카를 승격한다.
2. 파드 라벨을 `role=master`/`role=replica`로 재조정한다.
3. `redis-write` Service(selector: `role=master`)가 새 마스터를 자동으로 바라본다.

## 실무 포인트

- 학습 단계에서는 `redis-0` 직접 접근이 단순하지만, 운영 환경에서는 동적 마스터 디스커버리를 사용한다.
- `readinessProbe`가 통과한 파드만 Service 엔드포인트에 포함되게 구성한다.
- 장애 전환 시 애플리케이션 재시도(backoff)와 짧은 연결 타임아웃을 함께 설계한다.
- 레플리카 지연(`replication lag`) 모니터링 없이 읽기 분리를 도입하면 오래된 데이터를 읽는 문제가 커진다.

## 바로 적용 가능한 체크리스트

- [ ] `redis-read`(읽기) / `redis-write`(쓰기) 엔드포인트를 분리했다.
- [ ] 쓰기 서비스는 항상 현재 마스터만 가리키도록 설계했다.
- [ ] Sentinel 또는 Operator 기반 자동 Failover를 구성했다.
- [ ] 장애 전환 시 클라이언트 재연결/재시도 정책을 검증했다.
- [ ] 레플리카 지연, 장애 전환 시간, 쓰기 실패율을 모니터링한다.

## 실무 한 줄

읽기/쓰기 분리의 완성은 서비스를 나누는 것에서 끝나지 않고, **쓰기 주소가 장애 시 자동으로 새 마스터를 가리키게 만드는 것**까지 포함한다.

## 관련 개념

- StatefulSet / Headless Service
- Redis Sentinel
- Redis Operator
- Replication lag / Consistency

## 출처

- 쿠버네티스 창시자에게 배우는 모범 사례 2판
