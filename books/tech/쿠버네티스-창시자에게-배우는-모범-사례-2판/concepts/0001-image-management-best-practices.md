# 이미지 관리 모범 사례 (Image Management Best Practices)

## 정의

컨테이너 이미지를 만들고 배포하는 전 과정에서, 악성 코드 유입 가능성을 줄이고 재현 가능성을 높이기 위한 실무 원칙.

특히 이미지 빌드 과정은 외부 의존성, 베이스 이미지, 빌드 도구를 경유하므로 **공급망 공격(Software Supply Chain Attack)** 에 취약하다.

## 왜 중요한가?

- 신뢰한 의존성에 악성 코드가 삽입되면 애플리케이션 이미지까지 오염된다.
- 운영 환경에서 취약점이 늦게 발견되면 대응 비용이 급격히 커진다.
- 이미지 무결성이 약하면 "어떤 아티팩트를 언제 배포했는지" 추적하기 어렵다.

## 책 내용 핵심 정리

이미지 빌드 시에는 잘 알려진, 신뢰 가능한 프로바이더의 베이스 이미지를 사용하는 것이 중요하다.

- `from scratch`로 밑바닥부터 이미지를 구성하는 방식은 공급망 통제에 유리하다.
- 다만 이 방식은 Go 같은 정적 바이너리 언어에는 상대적으로 쉽지만,
- Python, JavaScript, Ruby 같은 인터프리터 언어에는 런타임/패키지 관리까지 직접 다뤄야 해서 복잡도가 크게 올라간다.

## 실무 포인트

### 1. 베이스 이미지 신뢰 체인 고정
- 공식/검증된 레지스트리만 허용한다.
- 태그(`:latest`) 대신 다이제스트(`@sha256:...`)로 고정한다.
- 팀 표준 베이스 이미지를 정하고 서비스별 예외를 승인 프로세스로 관리한다.

### 2. 빌드 결과의 재현성과 추적성 확보
- 의존성 락 파일을 반드시 사용한다.
- 빌드 시각, 커밋 SHA, 빌더 버전을 메타데이터로 남긴다.
- 같은 소스에서 같은 이미지가 생성되는지 주기적으로 검증한다.

### 3. 이미지 최소화와 공격면 축소
- 멀티 스테이지 빌드를 기본으로 사용한다.
- 런타임 이미지에는 빌드 도구/패키지 매니저를 남기지 않는다.
- 루트 실행을 피하고 불필요한 OS 패키지를 제거한다.

### 4. 스캔, 서명, 증명(SBOM/Provenance) 자동화
- 빌드 후 취약점 스캔을 필수 게이트로 둔다.
- SBOM 생성으로 포함된 라이브러리 목록을 추적 가능하게 만든다.
- 이미지 서명 검증을 배포 전 단계(Admission)에서 강제한다.

### 5. 배포 게이트 운영
- `Critical/High` 취약점 기준으로 배포 차단 규칙을 명확히 둔다.
- 예외 배포는 만료일이 있는 승인 티켓으로만 허용한다.
- "스캔만 하고 무시" 상태가 지속되지 않도록 주간 부채 리포트를 운영한다.

## 바로 적용 가능한 체크리스트

- [ ] `latest` 태그 사용 금지
- [ ] 내부 허용 베이스 이미지 목록 운영
- [ ] 빌드 파이프라인에 취약점 스캔 게이트 적용
- [ ] SBOM 아티팩트 저장 및 릴리스와 함께 보관
- [ ] 이미지 서명 및 클러스터 배포 시 검증
- [ ] 취약점 예외 정책(승인자, 만료일, 재검토 주기) 문서화

## 실무 한 줄

이미지 보안은 "좋은 베이스 이미지 선택"에서 시작하지만, 실제 완성은 **빌드-검증-서명-배포 게이트를 하나의 파이프라인으로 묶을 때** 이루어진다.

## 관련 개념

- 소프트웨어 공급망 보안 (Software Supply Chain Security)
- SLSA / Provenance
- SBOM
- 런타임 보안 정책 (Admission Control)

## 출처

- 쿠버네티스 창시자에게 배우는 모범 사례 2판
